name: Build and Test

on:
  pull_request:
    branches: [ master ]
  push:
    branches: [ master ]

jobs:
  test-build:
    runs-on: ubuntu-latest
    container: debian:trixie

    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Install system dependencies
      run: |
        apt update
        apt install -y python3-dev build-essential devscripts debhelper
        apt install -y dh-python pybuild-plugin-pyproject python3-pytest python3-all-dev
        apt install -y python3-setuptools

    - name: Test Debian package build
      run: |
        dpkg-buildpackage -us -uc -b

    - name: Install and test package
      run: |
        dpkg -i ../python3-truenas-pyos_*.deb
        python3 -m pytest tests/ -v
